# Maintainer: dodgejcr@gmail.com
# Maintainer: Bernhard Landauer <bernhard@manjaro.org>
# Contributor: Bhushan Shah <bshah@kde.org>
# Contributor: Chupligin Sergey (NeoChapay) <neochapay@gmail.com>

pkgname=libqofono-qt5
pkgver=0.120
pkgrel=2
pkgdesc="A library for accessing the ofono daemon, and a declarative plugin for it. This allows accessing ofono in qtquick and friends."
arch=('aarch64' 'x86_64')
url="https://github.com/sailfishos/libqofono"
license=('LGPL')
provides=('libqofono')
depends=('qt5-declarative'
    'qt5-xmlpatterns'
    'ofono>=1.29')

source=("${url}/archive/refs/tags/$pkgver.tar.gz"
        "context-preferred.patch"
        "mtk_settings_binding.patch")

sha256sums=('f024fb34a7e834053c84031a3baf9a9b3f4243168fb6fd5844dfef412882f4ec'
         'f793347078553903c7e6f6b235091c1863b18cd9b4078f34addc7a3ded7f2bd8'
         '1f63b04d05be4988498cba96c9700d6f4b6237325d65e508cf6fa2f21247a765')

prepare() {
    cd libqofono-$pkgver
    mkdir -p build

    # None of these patches break any abi or api, they only add qml functions
    # nor does these patches change the code, only adds code

    # Not upstreamed patches
    patch -Np1 -i "${srcdir}/context-preferred.patch"
    patch -Np1 -i "${srcdir}/mtk_settings_binding.patch"
}

build() {
    cd libqofono-$pkgver/build
    qmake-qt5 PREFIX=/usr ../libqofono.pro
	make
}

package() {
    cd libqofono-$pkgver/build
    make -j 1 INSTALL_ROOT="$pkgdir/" install

    # move *.prf into right folder
    mkdir -p ${pkgdir}/usr/lib/qt/mkspecs/features/
    mv ${pkgdir}/usr/share/qt5/mkspecs/features/qofono-qt5.prf ${pkgdir}/usr/lib/qt/mkspecs/features/qofono-qt5.prf

    rm -r "$pkgdir/opt"
}
