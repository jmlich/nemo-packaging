From 967a0204f19b85009dac1fb54681f9bb8d2e9407 Mon Sep 17 00:00:00 2001
From: Chupligin Sergey <neochapay@gmail.com>
Date: Mon, 7 Aug 2023 08:32:07 +0000
Subject: [PATCH] Allow build with qt6

---
 iodata-qt6.prf              | 15 +++++++++++++++
 root.pro                    |  6 ++++--
 src/iodata                  |  5 +++++
 src/src.pro                 |  6 ++++--
 src/storage                 |  5 +++++
 src/validator               |  5 +++++
 tests/tests.pro             |  3 ++-
 type-to-cxx/type-to-cxx.cpp |  8 ++++++++
 type-to-cxx/type-to-cxx.pro |  7 +++++--
 9 files changed, 53 insertions(+), 7 deletions(-)
 create mode 100644 iodata-qt6.prf

diff --git a/iodata-qt6.prf b/iodata-qt6.prf
new file mode 100644
index 0000000..0bfb5ae
--- /dev/null
+++ b/iodata-qt6.prf
@@ -0,0 +1,15 @@
+LIBS += -liodata-qt6
+
+QMAKE_EXTRA_COMPILERS += iodata_type_to_cxx iodata_type_to_h
+
+iodata_type_to_cxx.input = IODATA_TYPES
+iodata_type_to_cxx.output = iodata_${QMAKE_FILE_IN_BASE}.cpp
+iodata_type_to_cxx.variable_out = SOURCES
+iodata_type_to_cxx.commands = iodata-qt6-type-to-c++ ${QMAKE_FILE_IN} -o iodata_${QMAKE_FILE_IN_BASE}.cpp -d ${QMAKE_FILE_IN}.h
+
+iodata_type_to_h.input = IODATA_TYPES
+iodata_type_to_h.output = ${QMAKE_FILE_IN}.h
+iodata_type_to_h.variable_out = HEADERS
+iodata_type_to_h.commands = iodata-qt6-type-to-c++ ${QMAKE_FILE_IN} -o iodata_${QMAKE_FILE_IN_BASE}.cpp -d ${QMAKE_FILE_IN}.h
+
+# iodata-qt6-type-to-c++ ${QMAKE_FILE_IN} -d ${QMAKE_FILE_OUT}
diff --git a/root.pro b/root.pro
index c5fecb7..b02e0e8 100644
--- a/root.pro
+++ b/root.pro
@@ -2,8 +2,10 @@ TEMPLATE = subdirs
 
 SUBDIRS = src tests type-to-cxx
 
-prf.path =  $$[QT_INSTALL_DATA]/mkspecs/features
-prf.files = iodata-qt5.prf
+prf.path =  $$[QT_INSTALL_ARCHDATA]/mkspecs/features
+
+equals(QT_MAJOR_VERSION, 5): prf.files = iodata-qt5.prf
+equals(QT_MAJOR_VERSION, 6): prf.files = iodata-qt6.prf
 
 INSTALLS = prf
 
diff --git a/src/iodata b/src/iodata
index 4486ff6..63782b1 100644
--- a/src/iodata
+++ b/src/iodata
@@ -1 +1,6 @@
+#include <QtGlobal>
+#if QT_VERSION >= QT_VERSION_CHECK(6, 0, 0)
+#include <iodata-qt6/iodata.h>
+#elif QT_VERSION >= QT_VERSION_CHECK(5, 0, 0)
 #include <iodata-qt5/iodata.h>
+#endif
diff --git a/src/src.pro b/src/src.pro
index de1f834..36e5e20 100644
--- a/src/src.pro
+++ b/src/src.pro
@@ -5,11 +5,13 @@ QT -= gui
 HEADERS = iodata.h validator.h storage.h misc.h log.h
 SOURCES = iodata.cpp validator.cpp storage.cpp misc.cpp
 
-TARGET = iodata-qt5
+equals(QT_MAJOR_VERSION, 5): TARGET = iodata-qt5
+equals(QT_MAJOR_VERSION, 6): TARGET = iodata-qt6
 target.path = $$[QT_INSTALL_LIBS]
 
 devheaders.files = iodata.h validator.h storage.h iodata validator storage
-devheaders.path  = /usr/include/iodata-qt5
+equals(QT_MAJOR_VERSION, 5): devheaders.path  = /usr/include/iodata-qt5
+equals(QT_MAJOR_VERSION, 6): devheaders.path  = /usr/include/iodata-qt6
 
 INSTALLS = target devheaders
 
diff --git a/src/storage b/src/storage
index 8916762..a816a76 100644
--- a/src/storage
+++ b/src/storage
@@ -1 +1,6 @@
+#include <QtGlobal>
+#if QT_VERSION >= QT_VERSION_CHECK(6, 0, 0)
+#include <iodata-qt6/storage.h>
+#elif QT_VERSION >= QT_VERSION_CHECK(5, 0, 0)
 #include <iodata-qt5/storage.h>
+#endif
diff --git a/src/validator b/src/validator
index 4bbea6e..fcd9be2 100644
--- a/src/validator
+++ b/src/validator
@@ -1 +1,6 @@
+#include <QtGlobal>
+#if QT_VERSION >= QT_VERSION_CHECK(6, 0, 0)
+#include <iodata-qt6/validator.h>
+#elif QT_VERSION >= QT_VERSION_CHECK(5, 0, 0)
 #include <iodata-qt5/validator.h>
+#endif
diff --git a/tests/tests.pro b/tests/tests.pro
index a575814..9ffadc6 100644
--- a/tests/tests.pro
+++ b/tests/tests.pro
@@ -2,7 +2,8 @@ VERSION = $$(IODATA_VERSION)
 TEMPLATE = app
 QT -= gui
 
-PACKAGENAME = iodata-qt5
+equals(QT_MAJOR_VERSION, 5): PACKAGENAME = iodata-qt5
+equals(QT_MAJOR_VERSION, 6): PACKAGENAME = iodata-qt6
 
 TARGET = $${PACKAGENAME}-test
 
diff --git a/type-to-cxx/type-to-cxx.cpp b/type-to-cxx/type-to-cxx.cpp
index d9790c1..613bfb4 100644
--- a/type-to-cxx/type-to-cxx.cpp
+++ b/type-to-cxx/type-to-cxx.cpp
@@ -14,7 +14,11 @@ using namespace std;
 
 void dump_h(ostringstream &h, iodata::validator *v)
 {
+#if QT_VERSION >= QT_VERSION_CHECK(6, 0, 0)
+    h << "#include <iodata-qt6/validator>" << endl ;
+#elif QT_VERSION >= QT_VERSION_CHECK(5, 0, 0)
     h << "#include <iodata-qt5/validator>" << endl;
+#endif
     for (vector<string>::const_iterator it = v->v_namespace.begin(); it != v->v_namespace.end();
          ++it)
         h << "namespace " << *it << " {" << endl;
@@ -188,7 +192,11 @@ int main_try(int ac, char **av)
     }
 
     if (not c_output.empty()) {
+#if QT_VERSION >= QT_VERSION_CHECK(6, 0, 0)
+        string include = "#include <iodata-qt6/validator>\n";
+#else
         string include = "#include <iodata-qt5/validator>\n";
+#endif
 
         if (not h_output.empty())
             include += "#include \"" + h_output + "\"\n";
diff --git a/type-to-cxx/type-to-cxx.pro b/type-to-cxx/type-to-cxx.pro
index fa735d4..e74e9cd 100644
--- a/type-to-cxx/type-to-cxx.pro
+++ b/type-to-cxx/type-to-cxx.pro
@@ -1,11 +1,14 @@
 VERSION = $$(IODATA_VERSION)
 TEMPLATE = app
 QT -= gui
-TARGET = iodata-qt5-type-to-c++
+equals(QT_MAJOR_VERSION, 5): TARGET = iodata-qt5-type-to-c++
+equals(QT_MAJOR_VERSION, 6): TARGET = iodata-qt6-type-to-c++
 
 INSTALLS = target
 
-LIBS += -liodata-qt5 -lcrypt
+equals(QT_MAJOR_VERSION, 5): LIBS += -liodata-qt5 -lcrypt
+equals(QT_MAJOR_VERSION, 6): LIBS += -liodata-qt6 -lcrypt
+
 QMAKE_LIBDIR_FLAGS += -L../src
 
 SOURCES = type-to-cxx.cpp
-- 
2.41.0

